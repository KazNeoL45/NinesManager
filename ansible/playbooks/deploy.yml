---
- name: Deploy NinesManager application
  hosts: web
  become: yes
  tasks:
    - name: Pull latest code
      git:
        repo: "{{ git_repository }}"
        dest: "{{ app_path }}/releases/{{ ansible_date_time.epoch }}"
        version: "{{ git_branch | default('main') }}"
        accept_hostkey: yes
      become_user: "{{ app_user }}"

    - name: Create release symlink
      file:
        src: "{{ app_path }}/releases/{{ ansible_date_time.epoch }}"
        dest: "{{ app_path }}/releases/current"
        state: link

    - name: Install bundle
      bundler:
        state: present
        chdir: "{{ app_path }}/releases/current"
        deployment_mode: yes
        exclude_groups:
          - development
          - test
      become_user: "{{ app_user }}"
      environment:
        RAILS_ENV: "{{ rails_env }}"

    - name: Run database migrations
      shell: bundle exec rails db:migrate
      args:
        chdir: "{{ app_path }}/releases/current"
      become_user: "{{ app_user }}"
      environment:
        RAILS_ENV: "{{ rails_env }}"
        DATABASE_URL: "{{ database_url }}"

    - name: Precompile assets
      shell: bundle exec rails assets:precompile
      args:
        chdir: "{{ app_path }}/releases/current"
      become_user: "{{ app_user }}"
      environment:
        RAILS_ENV: "{{ rails_env }}"
        SECRET_KEY_BASE: "{{ secret_key_base }}"

    - name: Update current symlink
      file:
        src: "{{ app_path }}/releases/{{ ansible_date_time.epoch }}"
        dest: "{{ current_path }}"
        state: link
      notify: restart puma

    - name: Cleanup old releases
      shell: "ls -1dt {{ app_path }}/releases/* | tail -n +6 | xargs rm -rf"
      ignore_errors: yes

  handlers:
    - name: restart puma
      systemd:
        name: puma
        state: restarted
        daemon_reload: yes
