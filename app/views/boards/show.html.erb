<div class="space-y-10">

  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl text-gray-900">
        <%= @board.name %>
      </h1>
      <p class="text-gray-600 mt-1">
        <%= link_to @project.name, @project, class: "hover:text-gray-900 transition" %>
      </p>
    </div>

    <div class="flex gap-2">
      <button
        onclick="openColumnModal()"
        class="px-4 py-2 rounded-xl bg-white/60 backdrop-blur border border-white/70 text-gray-800 hover:bg-white/80 transition">
        Add Column
      </button>

      <%= link_to "Back",
        @project,
        class: "px-4 py-2 rounded-xl bg-white/60 backdrop-blur border border-white/70 text-gray-700 hover:bg-white/80 transition" %>
    </div>
  </div>

  <div class="overflow-x-auto pb-6">
    <div class="flex gap-6 min-w-max">
      <% @columns.each do |column| %>
        <div class="w-80 flex-shrink-0">
          <div class="rounded-3xl bg-white/50 backdrop-blur border border-white/60 overflow-hidden">
            <div class="px-5 py-4 border-b border-white/60 flex justify-between items-center">
              <h3 class="text-gray-900">
                <%= column.name %>
              </h3>
              <span class="text-sm text-gray-500">
                <%= column.tasks.count %>
              </span>
            </div>

            <div class="p-5 space-y-4 min-h-[220px]" data-column-id="<%= column.id %>">
              <% column.tasks.each do |task| %>
                <%= render "boards/task_card", task: task, project: @project %>
              <% end %>

              <%= link_to new_project_task_path(@project, column_id: column.id),
                class: "block py-4 rounded-xl border border-dashed border-gray-300 text-center text-sm text-gray-500 hover:border-gray-400 hover:text-gray-700 transition" do %>
                + Add Task
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

</div>

<div id="columnModal" class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
  <div class="w-full max-w-md rounded-3xl bg-white p-8 shadow-xl">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl text-gray-900">
        New Column
      </h2>
      <button onclick="closeColumnModal()" class="text-gray-400 hover:text-gray-600 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <%= form_with(
      model: [@project, @board, @board.columns.build],
      url: project_board_columns_path(@project, @board),
      method: :post,
      class: "space-y-6"
    ) do |form| %>

      <div>
        <%= form.label :name, "Name", class: "block text-sm text-gray-600 mb-2" %>
        <%= form.text_field :name,
          class: "w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition",
          placeholder: "To Do, In Progress, Done" %>
      </div>

      <div class="flex gap-3 pt-4">
        <button
          type="button"
          onclick="closeColumnModal()"
          class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
          Cancel
        </button>

        <%= form.submit "Create",
          class: "flex-1 py-3 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition cursor-pointer" %>
      </div>

    <% end %>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", () => {
    const draggables = document.querySelectorAll('[draggable="true"]')
    const columns = document.querySelectorAll("[data-column-id]")

    draggables.forEach(el => {
      el.addEventListener("dragstart", () => el.classList.add("opacity-50"))
      el.addEventListener("dragend", () => {
        el.classList.remove("opacity-50")
        const taskId = el.dataset.taskId
        const columnId = el.closest("[data-column-id]").dataset.columnId

        fetch(`/projects/<%= @project.id %>/tasks/${taskId}/move`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('[name="csrf-token"]').content
          },
          body: JSON.stringify({ column_id: columnId })
        })
      })
    })

    columns.forEach(column => {
      column.addEventListener("dragover", e => {
        e.preventDefault()
        const after = getAfter(column, e.clientY)
        const active = document.querySelector(".opacity-50")
        if (!active) return
        after ? column.insertBefore(active, after) : column.appendChild(active)
      })
    })

    function getAfter(container, y) {
      const items = [...container.querySelectorAll('[draggable="true"]:not(.opacity-50)')]
      return items.reduce((closest, child) => {
        const box = child.getBoundingClientRect()
        const offset = y - box.top - box.height / 2
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child }
        }
        return closest
      }, { offset: -Infinity }).element
    }
  })

  function openColumnModal() {
    const modal = document.getElementById("columnModal")
    modal.classList.remove("hidden")
    document.body.style.overflow = "hidden"
  }

  function closeColumnModal() {
    const modal = document.getElementById("columnModal")
    modal.classList.add("hidden")
    document.body.style.overflow = "auto"
  }

  document.addEventListener("turbo:load", () => {
    const modal = document.getElementById("columnModal")
    modal.addEventListener("click", e => {
      if (e.target === modal) closeColumnModal()
    })

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") closeColumnModal()
    })
  })
</script>
