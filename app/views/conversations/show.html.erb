<div style="display: flex; flex-direction: column; height: 100vh; width: 100%; background: #fff;">

  <header style="height: 56px; min-height: 56px; padding: 0 16px; border-bottom: 1px solid #e5e7eb; background: #fff; display: flex; align-items: center; gap: 16px;">
    <%= link_to conversations_path, style: "display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; color: #6b7280; border-radius: 8px; text-decoration: none;" do %>
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    <% end %>
    <h1 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0;">Direct Messages</h1>
    <div style="flex: 1; max-width: 400px; position: relative;">
      <svg width="16" height="16" fill="none" stroke="#9ca3af" viewBox="0 0 24 24" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <input type="text" id="conversation-search" placeholder="Search conversations..." oninput="filterConversations(this.value)" style="width: 100%; height: 36px; padding: 0 12px 0 40px; font-size: 14px; background: #f3f4f6; border: none; border-radius: 8px; outline: none; color: #374151;">
    </div>
    <button onclick="document.getElementById('new-conversation-modal').classList.remove('hidden')" style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; color: #6b7280; border-radius: 8px; background: none; border: none; cursor: pointer;">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
    </button>
  </header>

  <div style="display: flex; flex: 1; overflow: hidden;">

    <aside style="width: 300px; min-width: 300px; border-right: 1px solid #e5e7eb; background: #fff; overflow-y: auto;">
      <% @conversations.each do |conversation| %>
        <% other_participant = conversation.other_participant(current_user) %>
        <% last_message = conversation.last_message %>
        <% unread_count = conversation.unread_count_for(current_user) %>
        <% is_active = @conversation.id == conversation.id %>
        <%= link_to conversation_path(conversation), class: "conversation-item", data: { name: other_participant&.name&.downcase || '' }, style: "display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-decoration: none; border-bottom: 1px solid #f3f4f6; #{is_active ? 'background: #eef2ff; border-left: 3px solid #6366f1;' : ''}" do %>
          <div style="position: relative; flex-shrink: 0;">
            <div style="width: 44px; height: 44px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 16px; font-weight: 500;">
              <%= other_participant&.name&.first&.upcase || '?' %>
            </div>
            <% if other_participant&.online? %>
              <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; background: #22c55e; border: 2px solid #fff;"></div>
            <% elsif other_participant&.away? %>
              <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; background: #eab308; border: 2px solid #fff;"></div>
            <% end %>
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <span style="font-size: 14px; font-weight: 500; color: #111827; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><%= other_participant&.name || 'Unknown User' %></span>
              <% if last_message %>
                <span style="font-size: 12px; color: #9ca3af; flex-shrink: 0; margin-left: 8px;"><%= time_ago_in_words(last_message.created_at) %></span>
              <% end %>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 2px;">
              <% if last_message %>
                <span style="font-size: 13px; color: <%= unread_count > 0 ? '#374151; font-weight: 500' : '#6b7280' %>; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><%= last_message.content.presence || (last_message.attachments.attached? ? "ðŸ“Ž Attachment" : "") %></span>
              <% else %>
                <span style="font-size: 13px; color: #9ca3af; font-style: italic;">No messages yet</span>
              <% end %>
              <% if unread_count > 0 %>
                <span style="margin-left: 8px; padding: 2px 6px; border-radius: 9999px; background: #6366f1; color: #fff; font-size: 11px; font-weight: 500;"><%= unread_count > 99 ? '99+' : unread_count %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </aside>

    <main style="flex: 1; display: flex; flex-direction: column; background: #fff;">

      <div style="height: 56px; min-height: 56px; padding: 0 16px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
        <div style="position: relative; flex-shrink: 0;">
          <div style="width: 40px; height: 40px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 14px; font-weight: 500;">
            <%= @other_participant&.name&.first&.upcase || '?' %>
          </div>
          <% if @other_participant&.online? %>
            <div style="position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; border-radius: 50%; background: #22c55e; border: 2px solid #fff;"></div>
          <% elsif @other_participant&.away? %>
            <div style="position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; border-radius: 50%; background: #eab308; border: 2px solid #fff;"></div>
          <% end %>
        </div>
        <div>
          <div style="font-size: 14px; font-weight: 600; color: #111827;"><%= @other_participant&.name || 'Unknown User' %></div>
          <div style="font-size: 12px; color: #6b7280;">
            <% if @other_participant&.online? %>Active now<% elsif @other_participant&.away? %>Away<% else %>Offline<% end %>
          </div>
        </div>
      </div>

      <div id="messages-container" style="flex: 1; overflow-y: auto; padding: 16px; background: #f9fafb;">
        <% if @messages.any? %>
          <% @messages.each do |message| %>
            <% is_mine = message.user == current_user %>
            <div style="display: flex; margin-bottom: 16px; <%= is_mine ? 'justify-content: flex-end;' : 'justify-content: flex-start;' %>">
              <div style="display: flex; gap: 8px; max-width: 70%; <%= is_mine ? 'flex-direction: row-reverse;' : '' %>">
                <% unless is_mine %>
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 500; flex-shrink: 0;">
                    <%= message.user.name.first.upcase %>
                  </div>
                <% end %>
                <div>
                  <% unless is_mine %>
                    <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px;">
                      <span style="font-size: 12px; font-weight: 500; color: #111827;"><%= message.user.name %></span>
                      <span style="font-size: 11px; color: #9ca3af;"><%= message.created_at.strftime("%l:%M %p") %></span>
                    </div>
                  <% end %>
                  <div style="<%= is_mine ? 'background: #6366f1; color: #fff;' : 'background: #fff; color: #111827; border: 1px solid #e5e7eb;' %> border-radius: 16px; padding: 10px 14px;">
                    <% if message.content.present? %>
                      <p style="font-size: 14px; white-space: pre-wrap; word-break: break-word; margin: 0;"><%= message.content %></p>
                    <% end %>
                    <% if message.attachments.attached? %>
                      <div style="<%= 'margin-top: 8px;' if message.content.present? %>">
                        <% message.attachments.each do |attachment| %>
                          <% if attachment.content_type&.start_with?('image/') %>
                            <div style="border-radius: 8px; overflow: hidden; margin-top: 4px;">
                              <%= image_tag attachment, style: "max-width: 100%; height: auto; cursor: pointer; display: block;", alt: attachment.filename.to_s, onclick: "window.open('#{rails_blob_path(attachment)}', '_blank')" %>
                            </div>
                          <% else %>
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; <%= is_mine ? 'background: rgba(255,255,255,0.2);' : 'background: #f3f4f6;' %> border-radius: 8px; margin-top: 4px;">
                              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                              </svg>
                              <span style="font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><%= attachment.filename %></span>
                              <%= link_to "Download", rails_blob_path(attachment, disposition: "attachment"), style: "font-size: 12px; text-decoration: underline; color: inherit;" %>
                            </div>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                  <% if is_mine %>
                    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 4px;">
                      <span style="font-size: 11px; color: #9ca3af;"><%= message.created_at.strftime("%l:%M %p") %></span>
                      <%= button_to conversation_message_path(@conversation, message), method: :delete, data: { turbo_confirm: "Delete this message?" }, style: "font-size: 11px; color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0;" do %>Delete<% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
            <p style="font-size: 14px; color: #9ca3af; margin: 0;">No messages yet. Start the conversation!</p>
          </div>
        <% end %>
      </div>

      <div style="padding: 16px; border-top: 1px solid #e5e7eb; background: #fff;">
        <%= form_with model: [@conversation, @message], local: true, data: { turbo: false } do |form| %>
          <div style="display: flex; align-items: flex-end; gap: 12px;">
            <div style="flex: 1;">
              <%= form.text_area :content, rows: 1, id: "message_content", placeholder: "Message #{@other_participant&.name || ''}...", style: "width: 100%; padding: 10px 16px; font-size: 14px; background: #f3f4f6; border: none; border-radius: 20px; resize: none; outline: none; min-height: 40px; max-height: 120px; font-family: inherit;", oninput: "this.style.height = '40px'; this.style.height = Math.min(this.scrollHeight, 120) + 'px'; updateSendButton();" %>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                <%= form.file_field :attachments, multiple: true, accept: "image/*,.pdf,.doc,.docx,.txt", style: "display: none;", id: "message-attachments-input", onchange: "updateFileCount(this)" %>
                <button type="button" onclick="document.getElementById('message-attachments-input').click()" style="padding: 6px; color: #9ca3af; background: none; border: none; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                  </svg>
                </button>
                <span id="file-count-text" style="font-size: 12px; color: #6b7280;"></span>
              </div>
            </div>
            <%= form.submit "Send", id: "send-button", disabled: true, style: "height: 40px; padding: 0 20px; font-size: 14px; font-weight: 500; color: #fff; background: #6366f1; border: none; border-radius: 20px; cursor: pointer; opacity: 0.5;" %>
          </div>
        <% end %>
      </div>

    </main>

  </div>

</div>

<div id="new-conversation-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
  <div style="background: #fff; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); width: 100%; max-width: 400px; margin: 16px;">
    <div style="padding: 16px 24px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0;">New Message</h2>
      <button onclick="document.getElementById('new-conversation-modal').classList.add('hidden')" style="padding: 6px; color: #9ca3af; border-radius: 8px; background: none; border: none; cursor: pointer;">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div style="padding: 24px;">
      <%= form_with url: conversations_path, method: :post, local: true do |form| %>
        <div style="margin-bottom: 16px;">
          <label for="user_id" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">To:</label>
          <%= select_tag :user_id, options_from_collection_for_select(@available_users, :id, :name), prompt: "Select a user...", style: "width: 100%; height: 40px; padding: 0 12px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 8px; color: #111827; background: #fff;" %>
        </div>
        <div style="display: flex; gap: 12px; padding-top: 8px;">
          <button type="button" onclick="document.getElementById('new-conversation-modal').classList.add('hidden')" style="flex: 1; height: 40px; font-size: 14px; font-weight: 500; color: #374151; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer;">Cancel</button>
          <%= form.submit "Start Conversation", style: "flex: 1; height: 40px; font-size: 14px; font-weight: 500; color: #fff; background: #6366f1; border: none; border-radius: 8px; cursor: pointer;" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
  .hidden { display: none !important; }
  textarea:focus, input:focus { background: #fff !important; box-shadow: 0 0 0 2px #6366f1; }
</style>

<script>
  function updateFileCount(input) {
    const count = input.files.length;
    document.getElementById('file-count-text').textContent = count > 0 ? count + ' file' + (count > 1 ? 's' : '') + ' selected' : '';
    updateSendButton();
  }

  function updateSendButton() {
    const textarea = document.getElementById('message_content');
    const fileInput = document.getElementById('message-attachments-input');
    const sendBtn = document.getElementById('send-button');
    const hasContent = textarea && textarea.value.trim().length > 0;
    const hasFiles = fileInput && fileInput.files.length > 0;
    
    if (sendBtn) {
      if (hasContent || hasFiles) {
        sendBtn.disabled = false;
        sendBtn.style.opacity = '1';
        sendBtn.style.cursor = 'pointer';
      } else {
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';
        sendBtn.style.cursor = 'not-allowed';
      }
    }
  }

  function filterConversations(query) {
    const items = document.querySelectorAll('.conversation-item');
    const searchTerm = query.toLowerCase().trim();
    
    items.forEach(item => {
      const name = item.dataset.name || '';
      if (searchTerm === '' || name.includes(searchTerm)) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messages-container');
    if (container) container.scrollTop = container.scrollHeight;

    const textarea = document.getElementById('message_content');
    if (textarea) {
      textarea.addEventListener('input', updateSendButton);
      textarea.addEventListener('keyup', updateSendButton);
    }
  });
</script>
