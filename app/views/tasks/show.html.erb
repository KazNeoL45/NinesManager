<div class="max-w-4xl">

  <div class="bg-white rounded-3xl border border-gray-200 shadow-sm p-10 space-y-10">

    <div class="flex justify-between items-start gap-6">
      <div class="space-y-2">
        <h1 class="text-3xl text-gray-900">
          <%= @task.title %>
        </h1>
        <%= link_to @project.name, @project, class: "text-gray-500 hover:text-indigo-600 transition" %>
      </div>

      <div class="flex gap-2">
        <%= link_to "Edit",
          edit_project_task_path(@project, @task),
          class: "px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50 transition" %>

        <%= button_to "Delete",
          project_task_path(@project, @task),
          method: :delete,
          data: { turbo_confirm: "Are you sure?" },
          class: "px-4 py-2 rounded-xl border border-red-300 text-red-700 hover:bg-red-50 transition" %>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-8">

      <div class="space-y-2">
        <p class="text-sm text-gray-500">Priority</p>
        <span class="inline-flex px-3 py-1 rounded-full text-sm
          <%= @task.priority == 'urgent' ? 'bg-red-100 text-red-700' :
              @task.priority == 'high' ? 'bg-orange-100 text-orange-700' :
              @task.priority == 'medium' ? 'bg-yellow-100 text-yellow-700' :
              'bg-green-100 text-green-700' %>">
          <%= @task.priority.capitalize %>
        </span>
      </div>

      <div class="space-y-2">
        <p class="text-sm text-gray-500">Status</p>
        <span class="inline-flex px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm">
          <%= @task.status.humanize %>
        </span>
      </div>

      <% if @task.due_date %>
        <div class="space-y-2">
          <p class="text-sm text-gray-500">Due date</p>
          <p class="text-gray-900">
            <%= @task.due_date.strftime("%B %d, %Y") %>
          </p>
        </div>
      <% end %>

    </div>

    <div class="space-y-2">
      <p class="text-sm text-gray-500">Assigned to</p>
      <% if @task.assignees.any? %>
        <div class="space-y-2">
          <% @task.assignees.each do |assignee| %>
            <% assignment = @task.task_assignments.find_by(user: assignee) %>
            <div class="p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-100 shadow-sm">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">
                    <%= assignee.name.first.upcase %>
                  </div>
                  <p class="text-sm text-gray-900 font-medium truncate"><%= assignee.name %></p>
                </div>
                <div class="flex gap-2 items-center flex-shrink-0 ml-2">
                  <% all_available = (@available_assignees + [assignee]).uniq %>
                  <% if all_available.size > 1 %>
                    <%= form_with url: project_task_task_assignment_path(@project, @task, assignment), method: :patch, local: true, class: "inline-block" do |form| %>
                      <%= select_tag :user_id, options_from_collection_for_select(all_available, :id, :name, assignee.id), { onchange: "this.form.requestSubmit()", class: "text-xs px-2 py-1 border border-indigo-200 rounded bg-white focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" } %>
                    <% end %>
                  <% end %>
                  <button type="button" 
                    onclick='openRemoveModal(<%= assignment.id %>, "<%= j assignee.name %>", "<%= project_task_task_assignment_path(@project, @task, assignment) %>")'
                    class="text-xs px-2 py-1 text-red-600 hover:bg-red-50 rounded transition whitespace-nowrap">
                    Remove
                  </button>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-gray-500 text-sm text-center">Unassigned</p>
        </div>
      <% end %>
    </div>

    <div class="border-t border-gray-200 pt-4">
      <button type="button" onclick="toggleAssignSection()" class="w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900 transition py-2">
        <span>Assign Task</span>
        <svg id="assignToggleIcon" class="w-5 h-5 text-gray-500 transform transition-transform duration-300 ease-in-out" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="assignSection" class="mt-3 overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 0; opacity: 0;">
        <div class="pb-2">
          <% if @task.assignees.size < 2 && @available_assignees.any? %>
            <%= form_with url: project_task_task_assignments_path(@project, @task), method: :post, data: { turbo: false }, class: "flex gap-2" do |form| %>
              <%= select_tag :user_id, options_from_collection_for_select(@available_assignees, :id, :name), { prompt: "Select a member to assign", id: "assigneeSelect", onchange: "toggleAddButton()", class: "flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" } %>
              <%= submit_tag "Add Assignee", id: "addAssigneeBtn", disabled: true, class: "px-4 py-2 text-sm bg-indigo-300 text-white rounded-lg cursor-not-allowed whitespace-nowrap transition" %>
            <% end %>
          <% elsif @task.assignees.size >= 2 %>
            <p class="text-sm text-gray-500 text-center py-2">Task already has 2 assignees (maximum)</p>
          <% else %>
            <p class="text-sm text-gray-500 text-center py-2">No available members to assign</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="border-t border-gray-200 pt-4">
      <button type="button" onclick="toggleAttachSection()" class="w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900 transition py-2">
        <span>Attach Documents</span>
        <svg id="attachToggleIcon" class="w-5 h-5 text-gray-500 transform transition-transform duration-300 ease-in-out" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="attachSection" class="mt-3 overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 0; opacity: 0;">
        <div class="pb-2">
          <% if @task.documents.count < 5 %>
            <%= form_with model: [@project, @task], method: :patch, data: { turbo: false }, class: "space-y-3" do |form| %>
              <div class="flex items-center gap-3">
                <%= form.file_field :documents, multiple: true, accept: ".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg,.gif", id: "taskDocumentsInput", onchange: "updateDocCount(this)", class: "hidden" %>
                <button type="button" onclick="document.getElementById('taskDocumentsInput').click()" class="flex-1 px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg text-sm text-gray-600 hover:border-indigo-400 hover:text-indigo-600 transition text-center">
                  <svg class="w-5 h-5 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                  Click to select files
                </button>
              </div>
              <div class="flex items-center justify-between">
                <span id="docCountText" class="text-xs text-gray-500"></span>
                <span class="text-xs text-gray-400"><%= 5 - @task.documents.count %> slots remaining</span>
              </div>
              <%= form.submit "Upload Documents", id: "uploadDocsBtn", disabled: true, class: "w-full px-4 py-2 text-sm bg-indigo-300 text-white rounded-lg cursor-not-allowed transition" %>
            <% end %>
          <% else %>
            <p class="text-sm text-gray-500 text-center py-2">Maximum 5 documents reached</p>
          <% end %>
        </div>
      </div>
    </div>

    <% if @task.documents.attached? %>
      <div class="border-t border-gray-200 pt-4">
        <button type="button" onclick="toggleDocsViewSection()" class="w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900 transition py-2">
          <span>Attached Documents (<%= @task.documents.count %>)</span>
          <svg id="docsViewToggleIcon" class="w-5 h-5 text-gray-500 transform transition-transform duration-300 ease-in-out" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div id="docsViewSection" class="mt-3 overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 0; opacity: 0;">
          <div class="space-y-2 pb-2">
            <% @task.documents.each do |document| %>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                  <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div class="min-w-0">
                    <p class="text-sm text-gray-900 truncate"><%= document.filename %></p>
                    <p class="text-xs text-gray-500"><%= number_to_human_size(document.byte_size) %></p>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                  <%= link_to rails_blob_path(document, disposition: "attachment"), class: "text-xs px-2 py-1 text-indigo-600 hover:bg-indigo-50 rounded transition" do %>
                    Download
                  <% end %>
                  <%= button_to remove_document_project_task_path(@project, @task, document_id: document.id), method: :delete, data: { turbo_confirm: "Remove this document?" }, class: "text-xs px-2 py-1 text-red-600 hover:bg-red-50 rounded transition" do %>
                    Remove
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <div id="removeAssigneeModal" class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
      <div class="w-full max-w-md rounded-3xl bg-white p-8 shadow-xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl text-gray-900">Remove Assignee</h2>
          <button onclick="closeRemoveModal()" class="text-gray-400 hover:text-gray-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <p class="text-gray-700 mb-6">
          Are you sure you want to remove <span id="assigneeNameToRemove" class="font-semibold"></span> from this task?
        </p>

        <div class="flex gap-3 justify-end">
          <button onclick="closeRemoveModal()" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
            Cancel
          </button>
          <%= form_with url: "", method: :delete, id: "removeAssigneeForm", data: { turbo: false }, local: true, class: "inline-block" do |form| %>
            <%= submit_tag "Remove", class: "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition cursor-pointer" %>
          <% end %>
        </div>
      </div>
    </div>

    <script>
      function toggleSection(sectionId, iconId) {
        const section = document.getElementById(sectionId);
        const icon = document.getElementById(iconId);
        const isExpanded = section.style.maxHeight && section.style.maxHeight !== '0px';
        
        if (isExpanded) {
          section.style.maxHeight = '0px';
          section.style.opacity = '0';
          icon.classList.remove('rotate-180');
        } else {
          section.style.maxHeight = section.scrollHeight + 'px';
          section.style.opacity = '1';
          icon.classList.add('rotate-180');
        }
      }

      function toggleAssignSection() {
        toggleSection('assignSection', 'assignToggleIcon');
      }

      function toggleAttachSection() {
        toggleSection('attachSection', 'attachToggleIcon');
      }

      function toggleDocsViewSection() {
        toggleSection('docsViewSection', 'docsViewToggleIcon');
      }

      function openRemoveModal(assignmentId, assigneeName, assignmentPath) {
        const modal = document.getElementById('removeAssigneeModal');
        const form = document.getElementById('removeAssigneeForm');
        const nameSpan = document.getElementById('assigneeNameToRemove');
        
        nameSpan.textContent = assigneeName;
        form.action = assignmentPath;
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      function closeRemoveModal() {
        const modal = document.getElementById('removeAssigneeModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeRemoveModal();
        }
      });

      document.getElementById('removeAssigneeModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
          closeRemoveModal();
        }
      });

      function toggleAddButton() {
        const select = document.getElementById('assigneeSelect');
        const button = document.getElementById('addAssigneeBtn');
        if (select && button) {
          if (select.value && select.value !== '') {
            button.disabled = false;
            button.classList.remove('bg-indigo-300', 'cursor-not-allowed');
            button.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'cursor-pointer');
          } else {
            button.disabled = true;
            button.classList.add('bg-indigo-300', 'cursor-not-allowed');
            button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'cursor-pointer');
          }
        }
      }

      function updateDocCount(input) {
        const count = input.files.length;
        const countText = document.getElementById('docCountText');
        const uploadBtn = document.getElementById('uploadDocsBtn');
        
        if (count > 0) {
          countText.textContent = count + ' file' + (count > 1 ? 's' : '') + ' selected';
          uploadBtn.disabled = false;
          uploadBtn.classList.remove('bg-indigo-300', 'cursor-not-allowed');
          uploadBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'cursor-pointer');
        } else {
          countText.textContent = '';
          uploadBtn.disabled = true;
          uploadBtn.classList.add('bg-indigo-300', 'cursor-not-allowed');
          uploadBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'cursor-pointer');
        }
      }
    </script>

    <% if @task.description.present? %>
      <div class="space-y-3">
        <p class="text-sm text-gray-500">Description</p>
        <div class="prose max-w-none text-gray-900">
          <%= simple_format(@task.description) %>
        </div>
      </div>
    <% end %>

  </div>

  <div class="mt-6">
    <% if @task.column&.board %>
      <%= link_to "Back to board",
        project_board_path(@project, @task.column.board),
        class: "text-gray-500 hover:text-indigo-600 transition" %>
    <% else %>
      <%= link_to "Back to project",
        @project,
        class: "text-gray-500 hover:text-indigo-600 transition" %>
    <% end %>
  </div>

</div>
